<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:views="clr-namespace:MyApp.Views"
             xmlns:viewmodels="clr-namespace:MyApp.ViewModels"
             xmlns:models="clr-namespace:MyApp.Models"
             x:Class="MyApp.MainPage"
             x:DataType="viewmodels:MainPageViewModel"
             Title="TravelBuddy">

    <Grid>
        <ScrollView>
            <StackLayout Padding="16" Spacing="16">
                
                <!-- En-tête avec logo et titre -->
                <Frame BackgroundColor="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}" 
                       CornerRadius="16" 
                       Padding="20" 
                       HasShadow="True">
                    <StackLayout Orientation="Horizontal" Spacing="12">
                        <Label Text="🧭" FontSize="32" VerticalOptions="Center" />
                        <StackLayout VerticalOptions="Center">
                            <Label Text="TravelBuddy" 
                                   FontSize="24" 
                                   FontAttributes="Bold" 
                                   TextColor="White" />
                            <Label Text="Découvrez les lieux autour de vous" 
                                   FontSize="14" 
                                   TextColor="White" 
                                   Opacity="0.8" />
                        </StackLayout>
                    </StackLayout>
                </Frame>

                <!-- Statut de localisation -->
                <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#2C2C2E}"
                       BorderColor="{AppThemeBinding Light=#E5E5E7, Dark=#48484A}"
                       CornerRadius="12"
                       Padding="16"
                       HasShadow="True">
                    <StackLayout Orientation="Horizontal" Spacing="12">
                        <Label Text="{Binding CurrentLocation}" 
                               FontSize="14" 
                               VerticalOptions="Center"
                               HorizontalOptions="FillAndExpand" />
                        <Button Text="🔄" 
                                FontSize="16"
                                BackgroundColor="Transparent"
                                Command="{Binding RefreshLocationCommand}" />
                    </StackLayout>
                </Frame>

                <views:CompassView />

                <!-- Barre de recherche -->
                <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#2C2C2E}"
                       BorderColor="{AppThemeBinding Light=#E5E5E7, Dark=#48484A}"
                       CornerRadius="12"
                       Padding="16"
                       HasShadow="True">
                    <StackLayout Spacing="12">
                        <SearchBar Placeholder="Rechercher un lieu..." 
                                   Text="{Binding SearchQuery}"
                                   SearchCommand="{Binding SearchPlacesCommand}" />
                        
                        <!-- Filtres simplifiés -->
                        <Label Text="Filtres :" FontSize="16" FontAttributes="Bold" />
                        <Picker Title="Choisir un filtre"
                                ItemsSource="{Binding FilterOptions}"
                                SelectedItem="{Binding SelectedFilter}"
                                SelectedIndexChanged="OnFilterChanged" />
                    </StackLayout>
                </Frame>

                <!-- Bouton de recherche principal -->
                <Button Text="🔍 Chercher des lieux" 
                        Command="{Binding LoadPlacesCommand}"
                        BackgroundColor="{AppThemeBinding Light=#34C759, Dark=#30D158}"
                        TextColor="White"
                        FontSize="18"
                        FontAttributes="Bold"
                        CornerRadius="12"
                        Padding="0,16" />

                <!-- Message de statut -->
                <Label Text="{Binding StatusMessage}" 
                       FontSize="14" 
                       HorizontalTextAlignment="Center"
                       TextColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}" />

                <!-- Liste des lieux -->
                <Label Text="Lieux trouvés" 
                       FontSize="20" 
                       FontAttributes="Bold" />

                <CollectionView ItemsSource="{Binding Places}"
                                SelectionMode="Single"
                                SelectionChangedCommand="{Binding PlaceSelectedCommand}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Place">
                            <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#2C2C2E}"
                                   BorderColor="{AppThemeBinding Light=#E5E5E7, Dark=#48484A}"
                                   CornerRadius="12"
                                   Padding="16"
                                   Margin="8,4"
                                   HasShadow="True">
                                <StackLayout Spacing="8">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="60" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>

                                        <!-- Image du lieu -->
                                        <Frame Grid.Row="0" 
                                               Grid.Column="0" 
                                               Grid.RowSpan="2"
                                               CornerRadius="8" 
                                               Padding="0" 
                                               HasShadow="False"
                                               BackgroundColor="{AppThemeBinding Light=#F2F2F7, Dark=#3A3A3C}">
                                            <Image Source="{Binding PhotoUrl}" 
                                                   Aspect="AspectFill" 
                                                   HeightRequest="50" 
                                                   WidthRequest="50" />
                                        </Frame>

                                        <!-- Nom et catégorie -->
                                        <StackLayout Grid.Row="0" Grid.Column="1" Spacing="4">
                                            <Label Text="{Binding Name}" 
                                                   FontSize="16" 
                                                   FontAttributes="Bold" 
                                                   LineBreakMode="TailTruncation" />
                                            <Label Text="{Binding MainCategory}" 
                                                   FontSize="12" 
                                                   TextColor="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}" />
                                        </StackLayout>

                                        <!-- Distance -->
                                        <Label Grid.Row="0" 
                                               Grid.Column="2" 
                                               Text="{Binding FormattedDistance}" 
                                               FontSize="14" 
                                               FontAttributes="Bold"
                                               TextColor="{AppThemeBinding Light=#34C759, Dark=#30D158}"
                                               VerticalOptions="Center" />

                                        <!-- Adresse -->
                                        <Label Grid.Row="1" 
                                               Grid.Column="1" 
                                               Grid.ColumnSpan="2"
                                               Text="{Binding Address}" 
                                               FontSize="12" 
                                               TextColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}"
                                               LineBreakMode="TailTruncation" />
                                    </Grid>

                                    <!-- Description -->
                                    <Label Text="{Binding Description}" 
                                           FontSize="12" 
                                           LineBreakMode="WordWrap"
                                           MaxLines="2" />

                                    <!-- Téléphone -->
                                    <StackLayout Orientation="Horizontal" Spacing="8">
                                        <Label Text="📞" FontSize="12" />
                                        <Label Text="{Binding Phone}" 
                                               FontSize="12" 
                                               TextColor="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}" />
                                    </StackLayout>

                                </StackLayout>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Message si aucun lieu trouvé -->
                <StackLayout Padding="32">
                    <Label Text="🗺️" 
                           FontSize="48" 
                           HorizontalTextAlignment="Center" />
                    <Label Text="Aucun lieu trouvé" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           HorizontalTextAlignment="Center"
                           Margin="0,16,0,8" />
                    <Label Text="Essayez de modifier votre recherche ou vos filtres" 
                           FontSize="14" 
                           HorizontalTextAlignment="Center"
                           TextColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}" />
                </StackLayout>

            </StackLayout>
        </ScrollView>

        <!-- Indicateur de chargement -->
        <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=Black}" 
               Opacity="0.8" 
               IsVisible="{Binding IsLoading}">
            <StackLayout VerticalOptions="Center" 
                         HorizontalOptions="Center" 
                         Spacing="16">
                <ActivityIndicator IsRunning="{Binding IsLoading}" 
                                   Color="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}" 
                                   Scale="1.5" />
                <Label Text="Recherche en cours..." 
                       FontSize="16" 
                       HorizontalTextAlignment="Center" />
            </StackLayout>
        </Frame>
    </Grid>

</ContentPage>